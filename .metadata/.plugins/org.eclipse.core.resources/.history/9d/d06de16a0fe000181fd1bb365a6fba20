/*
 * sequencer.cpp
 *
 *  Created on: Nov 4, 2018
 *      Author: Roman
 */

#include <Sequencer.hpp>

Sequencer::Sequencer() : seqLength(SeqOptions::SIZE), currStep(0), prevTime(0) { };

void triggerStep(SeqStep step) {
	SendNoteOn( &(step.note) );
	HAL_Delay(step.length);       // ?? stupid
	SendNoteOff( &(step.note) );  // noteOff with same velocity
	HAL_Delay(step.length);       // stupid monophonic
}

void Sequencer::advanceStep(void) {
	if (sequence[currStep].repeats)
		for(u8 i = 0; i < sequence[currStep].repeats; i++) {
			triggerStep(sequence[currStep]);
		}
	else
		triggerStep(sequence[currStep]);
	/////////////////////////////////////
	/////////////////////////////////////
	currStep++;        // advance step
	while (sequence[currStep].action == SKIP)  // if the next step is SKIP - advannce more
		 currStep++;                           // until the next step is not SKIP

	if(sequence[currStep].action & JUMP)  // jump to hidden steps? Fun)
		currStep = sequence[currStep].jumpTo;
	else
		currStep++;

	if(currStep >= seqLength)
		currStep = 0;

}

void Sequencer::start(void) {
	triggerStep(sequence[currStep]);
	while(1)         // ?? stuupid
		Sequencer::advanceStep();
}
